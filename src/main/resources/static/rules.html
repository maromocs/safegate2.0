<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Manage Rules - SafeGate WAF</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/dark.css">
    <style>
        body { max-width: 1200px; margin: auto; padding: 1rem; }
        nav a { margin-right: 1rem; }
        table { width: 100%; }
        .form-container { margin-top: 2rem; padding: 1rem; border: 1px solid gray; border-radius: 5px; }
        textarea { width: 100%; }
        .actions button { margin-right: 0.5rem; margin-bottom: 0.5rem;}
    </style>
</head>
<body>
    <nav>
        <a href="/index.html">Home</a>
        <a href="/logs.html">View Logs</a>
        <a href="/testing.html">Testing</a>
    </nav>
    <h1>Manage WAF Rules</h1>
    <button onclick="fetchRules()">Refresh Rules</button>
    <table id="rules-table">
        <thead>
            <tr>
                <th>Rule ID</th>
                <th>Name</th>
                <th>Status</th>
                <th>Description</th>
                <th>Pattern</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <div class="form-container">
        <h2 id="form-title">Add New Rule</h2>
        <form id="rule-form">
            <input type="hidden" id="id" name="id">
            <input type="hidden" id="enabled" name="enabled" value="true">
            <label for="ruleId">Rule ID</label>
            <input type="text" id="ruleId" name="ruleId" required>
            <label for="name">Name</label>
            <input type="text" id="name" name="name" required>
            <label for="description">Description</label>
            <input type="text" id="description" name="description" required>
            <label for="pattern">Pattern (Java Regex)</label>
            <textarea id="pattern" name="pattern" rows="3" required></textarea>
            <button type="submit">Save Rule</button>
            <button type="button" onclick="resetForm()">Cancel Edit</button>
        </form>
    </div>

<script>
    const form = document.getElementById('rule-form');
    const formTitle = document.getElementById('form-title');

    function fetchRules() {
        fetch('/api/rules')
            .then(response => response.json())
            .then(data => {
                const tableBody = document.querySelector("#rules-table tbody");
                tableBody.innerHTML = "";
                data.sort((a,b) => a.id - b.id).forEach(rule => {
                    const status = rule.enabled ? '<span style="color: lightgreen;">Enabled</span>' : '<span style="color: orange;">Disabled</span>';
                    const toggleButtonText = rule.enabled ? 'Deactivate' : 'Activate';
                    const row = `<tr>
                        <td>${rule.ruleId}</td>
                        <td>${rule.name}</td>
                        <td>${status}</td>
                        <td>${rule.description}</td>
                        <td>${rule.pattern}</td>
                        <td class="actions">
                            <button onclick="toggleRuleStatus(${rule.id})">${toggleButtonText}</button>
                            <button onclick="editRule(${rule.id})">Edit</button>
                            <button onclick="deleteRule(${rule.id})">Delete</button>
                        </td>
                    </tr>`;
                    tableBody.innerHTML += row;
                });
            });
    }
    
    function toggleRuleStatus(id) {
        fetch(`/api/rules/${id}/toggle`, { method: 'PUT' })
            .then(response => {
                if (!response.ok) {
                    alert('Failed to toggle rule status.');
                }
                fetchRules(); // Refresh the table
            });
    }

    function editRule(id) {
        fetch(`/api/rules/${id}`)
            .then(response => response.json())
            .then(rule => {
                form.id.value = rule.id;
                form.enabled.value = rule.enabled;
                form.ruleId.value = rule.ruleId;
                form.name.value = rule.name;
                form.description.value = rule.description;
                form.pattern.value = rule.pattern;
                formTitle.textContent = "Edit Rule";
                form.scrollIntoView();
            });
    }

    function deleteRule(id) {
        if (!confirm("Are you sure you want to delete this rule?")) return;
        fetch(`/api/rules/${id}`, { method: 'DELETE' })
            .then(() => fetchRules());
    }

    function resetForm() {
        form.reset();
        form.id.value = '';
        form.enabled.value = 'true';
        formTitle.textContent = "Add New Rule";
    }

    form.addEventListener('submit', event => {
        event.preventDefault();
        const ruleId = form.id.value;
        const method = ruleId ? 'PUT' : 'POST';
        const url = ruleId ? `/api/rules/${ruleId}` : '/api/rules';
        
        const formData = Object.fromEntries(new FormData(form));
        formData.enabled = formData.id ? (formData.enabled === 'true') : true;

        fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        }).then(() => {
            fetchRules();
            resetForm();
        });
    });

    document.addEventListener("DOMContentLoaded", fetchRules);
</script>
</body>
</html>
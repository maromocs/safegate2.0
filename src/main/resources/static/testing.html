<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Testing - SafeGate WAF</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 100%);
            color: #e0e0e0;
            min-height: 100vh;
            padding: 2rem;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        nav {
            background: rgba(255, 255, 255, 0.05);
            padding: 1rem 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        nav a {
            color: #e0e0e0;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }

        nav a:hover, nav a.active {
            background: rgba(102, 126, 234, 0.2);
            border-color: rgba(102, 126, 234, 0.5);
        }

        h1 {
            font-size: 2.5rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 1rem;
            font-weight: 700;
        }

        h3 {
            color: #667eea;
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        p {
            color: #a0a0a0;
            margin-bottom: 2rem;
            line-height: 1.6;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        input[type="text"], input[type="file"], select, textarea {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 0.75rem;
            color: #e0e0e0;
            width: 100%;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            color: #b0b0b0;
            font-weight: 500;
        }

        .status-box {
            background: rgba(255, 255, 255, 0.05);
            padding: 1.5rem;
            border-radius: 12px;
            margin-top: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .status-box.active {
            border-color: rgba(76, 175, 80, 0.5);
            background: rgba(76, 175, 80, 0.1);
        }

        .status-box.inactive {
            border-color: rgba(255, 255, 255, 0.1);
        }

        #start-test-btn {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
        }

        #stop-test-btn {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-top: 2rem;
        }

        thead {
            background: rgba(102, 126, 234, 0.2);
        }

        th {
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: #ffffff;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        td {
            padding: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            vertical-align: top;
        }

        tbody tr {
            transition: all 0.3s ease;
        }

        tbody tr:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        #results-table ul {
            margin: 5px 0;
            padding-left: 20px;
        }

        #results-table strong {
            display: block;
            margin-top: 10px;
            color: #667eea;
        }

        .breakdown-section {
            background: rgba(255, 255, 255, 0.05);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 3px solid #667eea;
        }

        .passed-payloads {
            max-height: 300px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.3);
            padding: 1rem;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
        }

        #error-container {
            display: none;
            background: rgba(255, 107, 107, 0.1);
            border: 1px solid #ff6b6b;
            color: #ff6b6b;
            padding: 1.5rem;
            border-radius: 12px;
            margin: 1.5rem 0;
        }

        #error-container h4 {
            margin-top: 0;
            margin-bottom: 1rem;
        }

        #error-details {
            background: rgba(0, 0, 0, 0.3);
            padding: 1rem;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            margin-top: 1rem;
            font-size: 0.9rem;
        }

        .delete-btn {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
            border: none;
            padding: 0.4rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .delete-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.4);
        }

        #dataset-test-section {
            margin-top: 2rem;
            padding: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.03);
        }

        #dataset-test-section > div {
            margin-bottom: 1.5rem;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <nav>
            <a href="/index.html">üè† Home</a>
            <a href="/logs.html">üìä Test Results</a>
            <a href="/testing.html" class="active">üß™ Dataset Testing</a>
            <a href="/llm.html">‚öôÔ∏è LLM Configuration</a>
        </nav>
        <h1>Dataset Testing (LLM Evaluation)</h1>
        <p>Upload a dataset to evaluate the configured LLM model's detection performance. Signature rule testing has been removed; results are LLM-only.</p>

    <div id="dataset-test-section" style="margin-top: 1rem; padding: 1rem; border: 1px solid gray; border-radius: 5px;">
        <h3>Automated Dataset Test</h3>
        <form id="dataset-test-form">
            <div>
                <label for="dataset-file">Upload Dataset File:</label>
                <input type="file" id="dataset-file" name="file" required>
            </div>
            
            <div>
                <label for="dataset-format">Dataset Format:</label>
                <select id="dataset-format" name="datasetFormat" required>
                    <option value="AUTO" selected>Auto-detect (recommended)</option>
                    <option value="TXT">TXT (one payload per line)</option>
                    <option value="CSV">CSV</option>
                    <option value="JSON">JSON</option>
                    <option value="XML">XML</option>
                    <option value="TSV">TSV (tab-separated values)</option>
                </select>
            </div>
            
            <div id="format-detection-info" style="display: none; margin-top: 0.5rem; padding: 0.5rem; background-color: #1a1a1a; border-radius: 5px;">
                <span id="detected-format-message"></span>
            </div>
            
            <div>
                <label for="attack-type">Attack Type Identifier (optional):</label>
                <input type="text" id="attack-type" name="attackTypeTag" placeholder="e.g., SQLi, XSS, Path Traversal">
            </div>
            
            <div>
                <label>Number of Attacks to Test:</label>
                <div style="margin-top: 0.5rem;">
                    <label><input type="radio" name="samplingSize" value="All" checked> All</label>
                    <label style="margin-left: 1rem;"><input type="radio" name="samplingSize" value="Random 100"> Random 100</label>
                    <label style="margin-left: 1rem;"><input type="radio" name="samplingSize" value="Random 1,000"> Random 1,000</label>
                    <label style="margin-left: 1rem;"><input type="radio" name="samplingSize" value="Random 10,000"> Random 10,000</label>
                    <label style="margin-left: 1rem;"><input type="radio" name="samplingSize" value="Random 100,000"> Random 100,000</label>
                </div>
            </div>
            
            <div style="margin-top: 1rem;">
                <label for="seed-number">Seed Number (optional, for deterministic sampling):</label>
                <input type="number" id="seed-number" name="seed" placeholder="e.g., 42" min="0">
            </div>
        </form>
    </div>

    <div style="margin-top: 1rem;">
        <button id="start-test-btn" onclick="startTest()">Start New Test</button>
        <button id="stop-test-btn" onclick="stopTest()">Stop Current Test</button>
        <button id="refresh-llm-status" type="button" style="margin-left: 1rem;">Refresh LLM Status</button>
    </div>

    <div id="llm-status-banner" class="status-message" style="display:none; margin-top:10px; padding: 0.75rem; border: 1px solid gray; border-radius: 5px;"></div>

    <div id="llm-results" style="display:none; margin-top: 1rem; padding: 1rem; border: 1px solid gray; border-radius: 5px;">
        <h3>LLM Dataset Analysis Results</h3>
        <div id="llm-counters"></div>
        <div id="llm-bycategory"></div>

        <div style="margin-top: 1rem; display: flex; gap: 10px; flex-wrap: wrap;">
            <button id="download-safe-btn" type="button" style="background-color: #2e7d32;">Download SAFE Payloads (TXT)</button>
            <button id="download-malicious-btn" type="button" style="background-color: #c62828;">Download MALICIOUS Payloads (TXT)</button>
        </div>

        <div style="margin-top: 1.5rem;">
            <h4 style="margin-bottom: 0.5rem;">Malicious Payloads</h4>
            <div id="llm-malicious-list"></div>
        </div>

        <div style="margin-top: 1.5rem;">
            <h4 style="margin-bottom: 0.5rem;">Safe Payloads</h4>
            <div id="llm-safe-list"></div>
        </div>
    </div>

    <!-- Error message container -->
    <div id="error-container">
        <h4>Error Processing Dataset</h4>
        <div id="error-message"></div>
        <div id="error-details"></div>
        <button onclick="hideError()" style="margin-top: 10px;">Dismiss</button>
    </div>

    <div id="status-container" class="status-box inactive">
        <h3>Current Test Status</h3>
        <div id="status-content">
            Test mode is currently INACTIVE.
        </div>
    </div>

    <h2>Completed Test Runs</h2>
    <button onclick="fetchResults()">Refresh Results</button>
    <table id="results-table">
        <thead>
        <tr>
            <th>ID</th>
            <th>Start Time</th>
            <th>End Time</th>
            <th>Dataset File</th>
            <th>Test Parameters</th>
            <th>Detailed Breakdown</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
<script>
    let statusInterval;
    const startBtn = document.getElementById('start-test-btn');
    const stopBtn = document.getElementById('stop-test-btn');
    const statusContainer = document.getElementById('status-container');
    const statusContent = document.getElementById('status-content');
    const llmStatusBanner = document.getElementById('llm-status-banner');
    const refreshLlmStatusBtn = document.getElementById('refresh-llm-status');

    let currentMaliciousPayloads = [];
    let currentSafePayloads = [];

    function renderPayloadTable(items, containerId) {
        const container = document.getElementById(containerId);
        if (!items || items.length === 0) {
            container.innerHTML = '<em>None found.</em>';
            return;
        }

        let html = '<table style="width:100%; border-collapse: collapse;">';
        html += '<thead><tr style="border-bottom: 1px solid #555;"><th style="text-align:left;">Verdict/Category</th><th style="text-align:right;">Action</th></tr></thead><tbody>';
        
        items.forEach((it, idx) => {
            const id = `${containerId}-${idx}`;
            const payload = escapeHtml(String(it.payload || ''));
            const category = escapeHtml(String(it.category || ''));
            const reason = escapeHtml(String(it.reason || ''));
            const isMalicious = it.is_malicious === true;
            
            html += `
                <tr style="border-bottom: 1px solid #333;">
                    <td style="padding: 8px 0;">
                        <span style="color: ${isMalicious ? '#ff6b6b' : '#6bff6b'}; font-weight: bold;">${isMalicious ? 'MALICIOUS' : 'SAFE'}</span> - ${category}
                    </td>
                    <td style="padding: 8px 0; text-align: right;">
                        <button type="button" onclick="togglePayloadDetails('${id}')" style="padding: 2px 8px; font-size: 0.8rem; background-color: #444;">Expand/Collapse</button>
                    </td>
                </tr>
                <tr id="${id}" style="display:none; background-color: #111;">
                    <td colspan="2" style="padding: 10px; border: 1px dashed #555;">
                        <div style="margin-bottom: 5px;"><strong>Raw Payload:</strong></div>
                        <pre style="white-space: pre-wrap; word-break: break-all; background: #000; padding: 10px; border-radius: 4px; color: #eee; font-family: monospace;">${payload}</pre>
                        <div style="margin-top: 8px;"><strong>Reasoning:</strong> ${reason}</div>
                    </td>
                </tr>
            `;
        });
        
        html += '</tbody></table>';
        container.innerHTML = html;
    }

    window.togglePayloadDetails = function(id) {
        const el = document.getElementById(id);
        if (el.style.display === 'none') {
            el.style.display = 'table-row';
        } else {
            el.style.display = 'none';
        }
    };

    function downloadPayloads(items, type) {
        if (!items || items.length === 0) {
            alert("No payloads available to download.");
            return;
        }
        
        let content = "";
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
        let filename = `llm_${type}_payloads_${timestamp}.txt`;
        
        if (type === 'safe') {
            content = "SAFE PAYLOADS REPORT\n";
            content += "=".repeat(20) + "\n\n";
            content += items.map((it, idx) => `[Entry ${idx+1}]\n${it.payload}`).join("\n\n" + "-".repeat(10) + "\n\n");
        } else {
            content = "MALICIOUS PAYLOADS REPORT\n";
            content += "=".repeat(20) + "\n\n";
            content += items.map((it, idx) => `[Entry ${idx+1}]\nCategory: ${it.category}\nPayload: ${it.payload}`).join("\n\n" + "-".repeat(10) + "\n\n");
        }
        
        const blob = new Blob([content], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
    }

    function refreshLlmStatus() {
        Promise.all([
            fetch('/api/llm/config').then(r => r.json()).catch(() => ({})),
            fetch('/api/llm/models').then(r => r.json()).catch(() => ({}))
        ]).then(([cfg, models]) => {
            const mode = cfg.llmMode || 'DISABLED';
            const provider = cfg.provider || 'ollama';
            const model = cfg.model || '';
            const gpu = cfg.gpuEnabled ? 'On' : 'Off';
            const avail = Array.isArray(models.available) ? models.available : [];
            const rec = Array.isArray(models.recommended) ? models.recommended : [];
            const reachable = (avail.length > 0 || rec.length > 0) ? 'Yes' : 'Unknown';
            const datasetActive = (mode === 'TEST_ONLY' || mode === 'NORMAL_AND_TEST') ? 'Yes' : 'No';
            llmStatusBanner.style.display = 'block';
            llmStatusBanner.innerHTML = `<strong>LLM Status</strong><br>
                Mode: ${mode} | Provider/Model: ${provider}/${model} | GPU: ${gpu}<br>
                Analyzer reachable: ${reachable} | Will analyze dataset: ${datasetActive}`;
        }).catch(() => {
            llmStatusBanner.style.display = 'block';
            llmStatusBanner.textContent = 'Failed to refresh LLM status.';
        });
    }

    refreshLlmStatusBtn.addEventListener('click', refreshLlmStatus);
    document.addEventListener('DOMContentLoaded', refreshLlmStatus);

    // Function to handle file selection and provide format feedback
    function handleFileSelection() {
        const fileInput = document.getElementById('dataset-file');
        const formatInfo = document.getElementById('format-detection-info');
        const formatMessage = document.getElementById('detected-format-message');
        
        if (fileInput.files.length > 0) {
            const file = fileInput.files[0];
            const fileName = file.name;
            const fileExtension = fileName.split('.').pop().toLowerCase();
            
            // Show format detection info
            formatInfo.style.display = 'block';
            
            // Set message based on file extension
            if (['csv', 'json', 'xml', 'txt', 'tsv'].includes(fileExtension)) {
                formatMessage.innerHTML = `<span style="color: lightgreen;">‚úì</span> File appears to be ${fileExtension.toUpperCase()} format based on extension. Auto-detection will confirm.`;
                
                // Auto-select the format based on extension if not using auto-detect
                const formatSelect = document.getElementById('dataset-format');
                if (formatSelect.value !== 'AUTO') {
                    const matchingOption = Array.from(formatSelect.options).find(option => 
                        option.value.toLowerCase() === fileExtension.toLowerCase());
                    
                    if (matchingOption) {
                        formatSelect.value = matchingOption.value;
                    }
                }
            } else {
                formatMessage.innerHTML = `<span style="color: orange;">‚ö†</span> Unknown file extension (.${fileExtension}). Using auto-detection.`;
            }
        } else {
            // Hide format detection info if no file is selected
            formatInfo.style.display = 'none';
        }
    }

    function startTest() {
        if (!confirm("Starting a new test will clear any running test data. Proceed?")) return;
        
        // Check if a dataset file is selected
        const datasetFile = document.getElementById('dataset-file');
        if (datasetFile.files.length > 0) {
            // Dataset test
            const form = document.getElementById('dataset-test-form');
            const formData = new FormData(form);
            
            // Show loading state
            startBtn.disabled = true;
            statusContainer.className = 'status-box active';
            statusContent.innerHTML = '<p><strong>Test is ACTIVE</strong></p><p>Processing dataset, please wait...</p>';
            
            fetch('/api/tests/start-dataset-test', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.error || 'Error processing dataset');
                    });
                }
                return response.json();
            })
            .then(data => {
                // Handle the enhanced response
                if (data.detectedFormat) {
                    const formatInfo = document.getElementById('format-detection-info');
                    const formatMessage = document.getElementById('detected-format-message');
                    
                    formatInfo.style.display = 'block';
                    formatMessage.innerHTML = `<span style="color: lightgreen;">‚úì</span> Successfully processed file using ${data.detectedFormat} format.`;
                }

                // Render LLM results if present
                if (data.llmStats) {
                    const llmDiv = document.getElementById('llm-results');
                    const countersDiv = document.getElementById('llm-counters');
                    const byCatDiv = document.getElementById('llm-bycategory');
                    llmDiv.style.display = 'block';

                    const s = data.llmStats;
                    countersDiv.innerHTML = `<p><strong>Counters:</strong> Total=${s.total || 0}, Malicious=${s.malicious || 0}, Safe=${s.safe || 0}</p>`;

                    const byCat = s.byCategory || {};
                    let bcHtml = '<strong>By Category:</strong><ul>';
                    for (const [k, v] of Object.entries(byCat)) {
                        bcHtml += `<li>${k}: ${v}</li>`;
                    }
                    bcHtml += '</ul>';
                    byCatDiv.innerHTML = bcHtml;

                    currentMaliciousPayloads = data.llmMaliciousPayloads || [];
                    currentSafePayloads = data.llmSafePayloads || [];
                    
                    renderPayloadTable(currentMaliciousPayloads, 'llm-malicious-list');
                    renderPayloadTable(currentSafePayloads, 'llm-safe-list');
                }
                
                checkStatus();
                fetchResults();
            })
            .catch(error => {
                showError(error.message);
                startBtn.disabled = false;
                statusContainer.className = 'status-box inactive';
                statusContent.innerHTML = 'Test mode is currently INACTIVE.';
            });
        } else {
            // Regular test
            fetch('/api/tests/start', { method: 'POST' }).then(() => checkStatus());
        }
    }

    function stopTest() {
        if (!confirm("Are you sure you want to stop the current test?")) return;
        fetch('/api/tests/stop', { method: 'POST' }).then(() => {
            checkStatus();
            fetchResults();
        });
    }

    function checkStatus() {
        fetch('/api/tests/status')
            .then(response => response.json())
            .then(status => {
                if (status.testModeEnabled) {
                    startBtn.disabled = true;
                    stopBtn.disabled = false;
                    statusContainer.className = 'status-box active';

                    const run = status.currentRun;
                    const startTime = new Date(run.startTime).toLocaleString();
                    const duration = ((new Date() - new Date(run.startTime)) / 1000).toFixed(1);
                    let countsHtml = '<ul>';
                    run.blockCounts.forEach(bc => {
                        const name = bc.detectionCategory || bc.ruleName || 'UNKNOWN';
                        countsHtml += `<li>${name}: ${bc.count}</li>`;
                    });
                    countsHtml += '</ul>';

                    statusContent.innerHTML = `
                        <p><strong>Test is ACTIVE</strong></p>
                        <p><strong>Started:</strong> ${startTime}</p>
                        <p><strong>Duration:</strong> ${duration} seconds</p>
                        <p><strong>Passed Requests:</strong> ${run.totalPassed}</p>
                        <p><strong>Blocked Requests:</strong> ${run.totalBlocked}</p>
                        <div><strong>Blocked by Category:</strong>${countsHtml}</div>`;
                    if (!statusInterval) {
                       statusInterval = setInterval(checkStatus, 2000);
                    }
                } else {
                    startBtn.disabled = false;
                    stopBtn.disabled = true;
                    statusContainer.className = 'status-box inactive';
                    statusContent.innerHTML = 'Test mode is currently INACTIVE.';
                    if (statusInterval) {
                        clearInterval(statusInterval);
                        statusInterval = null;
                    }
                }
            });
    }

    function fetchResults() {
        fetch('/api/tests/results')
            .then(response => response.json())
            .then(data => {
                const tableBody = document.querySelector("#results-table tbody");
                tableBody.innerHTML = "";
                data.reverse().forEach(run => {
                    const startTime = new Date(run.startTime).toLocaleString();
                    const endTime = new Date(run.endTime).toLocaleString();
                    
                    // Dataset file name or "N/A" for manual tests
                    const datasetFile = run.datasetFileName || "N/A";
                    
                    // Test parameters
                    const testParams = run.testParameters || "Manual Test";
                    
                    // Create detailed breakdown
                    let detailedBreakdown = '';
                    
                    // Overall statistics
                    detailedBreakdown += `
                        <div class="breakdown-section">
                            <strong>Overall:</strong>
                            <ul>
                                <li>Total Requests Sent: ${run.totalPassed + run.totalBlocked}</li>
                                <li>Passed: ${run.totalPassed}</li>
                                <li>Blocked: ${run.totalBlocked}</li>
                            </ul>
                        </div>
                    `;
                    
                    // Analysis for tagged attacks
                    if (run.attackTypeTag && run.totalMaliciousRequests > 0) {
                        const effectiveness = (run.totalMaliciousBlocked / run.totalMaliciousRequests * 100).toFixed(1);
                        detailedBreakdown += `
                            <div class="breakdown-section">
                                <strong>Analysis for "${run.attackTypeTag}" Attacks:</strong>
                                <ul>
                                    <li>Total Malicious ("${run.attackTypeTag}") Requests: ${run.totalMaliciousRequests}</li>
                                    <li>Blocked: ${run.totalMaliciousBlocked} (${effectiveness}% effectiveness)</li>
                                    <li>Passed (Bypassed WAF): ${run.totalMaliciousRequests - run.totalMaliciousBlocked}</li>
                                </ul>
                            </div>
                        `;
                    }
                    
                    // Blocked by rule
                    if (run.blockCounts && run.blockCounts.length > 0) {
                        detailedBreakdown += '<div class="breakdown-section"><strong>Blocked by Category:</strong><ul>';
                        run.blockCounts.forEach(bc => {
                            const name = bc.detectionCategory || bc.ruleName || 'UNKNOWN';
                            detailedBreakdown += `<li>${name}: ${bc.count} requests</li>`;
                        });
                        detailedBreakdown += '</ul></div>';
                    }
                    
                    // Passed attack payloads
                    if (run.passedPayloads && run.passedPayloads.length > 0) {
                        detailedBreakdown += '<div class="breakdown-section"><strong>Passed Attack Payloads:</strong><div class="passed-payloads"><ul>';
                        // Limit to first 10 payloads to avoid overwhelming the UI
                        const displayPayloads = run.passedPayloads.slice(0, 10);
                        displayPayloads.forEach(pp => {
                            detailedBreakdown += `<li>${escapeHtml(pp.payload)}</li>`;
                        });
                        if (run.passedPayloads.length > 10) {
                            detailedBreakdown += `<li>... and ${run.passedPayloads.length - 10} more</li>`;
                        }
                        detailedBreakdown += '</ul></div></div>';
                    }

                    const row = `<tr>
                        <td>${run.id}</td>
                        <td>${startTime}</td>
                        <td>${endTime}</td>
                        <td>${datasetFile}</td>
                        <td>${testParams}</td>
                        <td>${detailedBreakdown}</td>
                        <td><button class="delete-btn" onclick="deleteTestRun(${run.id})">Delete</button></td>
                    </tr>`;
                    tableBody.innerHTML += row;
                });
            });
    }
    
    // Helper function to escape HTML to prevent XSS
    function escapeHtml(unsafe) {
        return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }
    
    // Function to display error messages in the error container
    function showError(message, details = '', suggestion = '') {
        const errorContainer = document.getElementById('error-container');
        const errorMessage = document.getElementById('error-message');
        const errorDetails = document.getElementById('error-details');
        
        // Parse the error message to extract useful information
        let mainMessage = message;
        let detailsMessage = details;
        let suggestionMessage = suggestion;
        
        // Check if the error is from the enhanced API response
        if (typeof message === 'object' && message !== null) {
            // This is likely a parsed JSON error object
            mainMessage = message.error || 'Unknown error';
            detailsMessage = message.errorType ? `Error type: ${message.errorType}` : '';
            suggestionMessage = message.suggestion || '';
            
            // Format the details message
            if (detailsMessage && suggestionMessage) {
                detailsMessage = `${detailsMessage}\n\n${suggestionMessage}`;
            } else if (suggestionMessage) {
                detailsMessage = suggestionMessage;
            }
        } else {
            // Check for specific error patterns in string messages
            if (message.includes('Unexpected end of JSON input')) {
                mainMessage = 'Invalid JSON format in the uploaded file.';
                detailsMessage = 'The file you uploaded could not be parsed as JSON. This could be because:\n' +
                    '1. The file is not actually in JSON format\n' +
                    '2. The JSON is malformed or incomplete\n' +
                    '3. You selected JSON format but uploaded a different file type\n\n' +
                    'Try selecting "Auto-detect" format or a different format (like CSV or TXT) that matches your file content.';
            } else if (message.includes('CSV file is empty or has no headers')) {
                mainMessage = 'CSV file has no headers.';
                detailsMessage = 'The system could not find a header row in your CSV file. Please ensure:\n' +
                    '1. Your CSV file is not empty\n' +
                    '2. The first row contains column names\n' +
                    '3. Column names are properly formatted (with or without quotes)\n\n' +
                    'The CSIC 2010 dataset should have a header row with column names including "payload".';
            } else if (message.includes('No payloads could be extracted')) {
                mainMessage = 'No payloads found in CSV file.';
                detailsMessage = 'The system could not extract any payloads from your CSV file. Please ensure:\n' +
                    '1. The file contains data rows (not just a header)\n' +
                    '2. The "payload" column (or the column being used) contains non-empty values\n' +
                    '3. The CSV format is correct (commas as separators, optional quotes around values)\n\n' +
                    'If your file has a different structure, you may need to reformat it.';
            } else if (message.includes('No column named \'payload\'')) {
                mainMessage = 'Payload column not found in CSV file.';
                detailsMessage = 'The system could not find a column named "payload" in your CSV file. Please ensure:\n' +
                    '1. Your CSV file has a header row with column names\n' +
                    '2. One of the columns is named "payload" (case insensitive)\n' +
                    '3. If your file uses a different column name for payloads, consider renaming it\n\n' +
                    'The CSIC 2010 dataset should have a column named "payload" that contains the attack payloads.';
            } else if (message.includes('CSV') && (message.includes('column') || message.includes('payload'))) {
                mainMessage = 'CSV parsing issue with payload column.';
                detailsMessage = 'The system had trouble identifying or processing the payload column in your CSV file. Please ensure:\n' +
                    '1. Your CSV file has a header row\n' +
                    '2. There is a column named "payload" (case insensitive)\n' +
                    '3. The payload column contains the attack payloads you want to test\n\n' +
                    'If your file has a different structure, you may need to reformat it.';
            } else if (message.includes('Error parsing CSV')) {
                mainMessage = 'Error parsing CSV file.';
                detailsMessage = 'The system encountered an error while parsing your CSV file. This could be because:\n' +
                    '1. The file format is not standard CSV (comma-separated values)\n' +
                    '2. There are formatting issues like unbalanced quotes or special characters\n' +
                    '3. The file encoding is not supported\n\n' +
                    'Try opening the file in a text editor to check its format, or use a tool like Excel to export it as a standard CSV.';
            } else if (message.includes('format')) {
                mainMessage = 'File format detection issue.';
                detailsMessage = 'The system had trouble detecting or processing the file format. Try:\n' +
                    '1. Using the "Auto-detect" option\n' +
                    '2. Ensuring your file matches the selected format\n' +
                    '3. Checking if the file is properly formatted\n\n' +
                    'If problems persist, try converting your file to a simpler format like TXT.';
            }
        }
        
        // Set the error messages
        errorMessage.textContent = mainMessage;
        errorDetails.textContent = detailsMessage || 'No additional details available.';
        
        // Show the error container
        errorContainer.style.display = 'block';
        
        // Scroll to the error container
        errorContainer.scrollIntoView({ behavior: 'smooth' });
    }
    
    // Function to hide the error container
    function hideError() {
        const errorContainer = document.getElementById('error-container');
        errorContainer.style.display = 'none';
    }
    
    // Function to delete a test run
    function deleteTestRun(id) {
        if (!confirm(`Are you sure you want to delete test run #${id}? This action cannot be undone.`)) {
            return;
        }
        
        fetch(`/api/tests/results/${id}`, {
            method: 'DELETE'
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(data.error || 'Error deleting test run');
                });
            }
            return response.json();
        })
        .then(data => {
            // Show success message
            alert('Test run deleted successfully');
            // Refresh the results table
            fetchResults();
        })
        .catch(error => {
            // Show error message
            showError(error.message);
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        // Initialize the page
        checkStatus();
        fetchResults();
        
        // Add event listener for file selection
        const fileInput = document.getElementById('dataset-file');
        fileInput.addEventListener('change', handleFileSelection);
        
        // Add event listener for format dropdown changes
        const formatSelect = document.getElementById('dataset-format');
        formatSelect.addEventListener('change', () => {
            // If a file is already selected, update the format info
            if (fileInput.files.length > 0) {
                handleFileSelection();
            }
        });

        // Add event listeners for download buttons
        const downloadSafeBtn = document.getElementById('download-safe-btn');
        const downloadMaliciousBtn = document.getElementById('download-malicious-btn');
        
        if (downloadSafeBtn) {
            downloadSafeBtn.addEventListener('click', () => downloadPayloads(currentSafePayloads, 'safe'));
        }
        if (downloadMaliciousBtn) {
            downloadMaliciousBtn.addEventListener('click', () => downloadPayloads(currentMaliciousPayloads, 'malicious'));
        }
    });
</script>
    </div>
</body>
</html>